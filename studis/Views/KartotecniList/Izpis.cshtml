@model studis.Models.sifrant_studijskiprogram
@using studis.Models

@{
    ViewBag.Title = "Kartotečni list";
    Layout = "~/Views/Shared/_Layout.cshtml";
    StudentHelper sh = new StudentHelper();
}

<h2>Kartotečni list</h2>

<!--- selektor za vsa/zadnje polaganje; selektor za študijski program -->
@using (Html.BeginForm("Izpis", "KartotecniList", new { vpisna = ViewBag.Vpisna }, FormMethod.Post, null))
{
    @Html.DropDownList("polaganja", new SelectList(new[] { "Zadnje polaganje", "Vsa polaganja" })) <input type="submit" value="Izpiši" />
}
    
<br />

@if (@ViewBag.Izbira != null)
{
    var skupneOcene = 0.0;
    var skupniSestevek = 0.0;
    var skupneTocke = 0;
    double skupnoPovprecje = 0;
        
    if (@ViewBag.Izbira == 0)
    {
        <div id="izpis">
            <!--- foreach {leto študija} -->
            @foreach (var v in @ViewBag.Vpisi)
            {
                var tocke = 0;
                var stOcen = 0.0;
                var sestevek = 0.0;
                var opravil = 0;
                double povprecje = 0;
                int temp;
                int ocena;

                <!-- GLAVA -->
                
                <h2>@v.sifrant_studijskiprogram.naziv </h2>
                <table>
                    <tbody>
                        <tr>
                            <th>Študijsko leto</th>
                            <td>@v.sifrant_studijskoleto.naziv</td>
                        </tr>
                        <tr>
                            <th>Letnik</th>
                            <td>@v.letnikStudija</td>
                        </tr>
                        @if (@v.letnikStudija == 3 && @v.studijskiProgram == 1000468 && @ViewBag.Moduli != null)
                        {
                            var st = 1;
                            foreach (var mod in @ViewBag.Moduli)
                            {
                                <tr>
                                    <th>Moduli @st</th>
                                    <td>@mod</td>
                                </tr>
                                st++;
                            }
                        }
                        <tr>
                            <th>Vrsta vpisa</th>
                            <td>@v.sifrant_vrstavpisa.naziv</td>
                        </tr>
                        <tr>
                            <th>Način študija</th>
                            <td>@v.sifrant_nacinstudija.naziv</td>
                        </tr>
                    </tbody>
                </table>

                <br />

                <!-- IZPIS -->
                <table>
                    <thead>
                        <tr>
                            <th>Šifra</th>
                            <th>Predmet</th>
                            <th>Izvajalec</th>
                            <th>Letnik</th>
                            <th>Datum</th>
                            <th>Polaganje</th>
                            <th>Polaganje v tem letu</th>
                            <th>KT</th>
                            <th>Ocena</th>
                        </tr>
                    </thead>

                    <tbody>
                        <!-- ponavljanje -->
                        @if (v.vrstaVpisa == 2)
                        {
                            foreach (var i in @ViewBag.Izvajanja)
                            {
                                var pisal = 0;
                                foreach (var r in @ViewBag.Roki)
                                {
                                    foreach (var p in @ViewBag.Prijave)
                                    {
                                        if (@ViewBag.Zacasni.izvajanjes.Contains(i) && i.izpitniroks.Contains(r) && (p.vpisId == @ViewBag.Zacasni.id || p.vpisId == v.id ) && r.id == p.izpitnirokId && pisal == 0)
                                        {
                                            pisal++;

                                            <tr>
                                                <td>@i.predmet.koda</td>
                                                <td>@i.predmet.ime</td>
                                                <td>
                                                    @i.profesor.ime @i.profesor.priimek
                                                    @if (@i.izvajalec2Id != null)
                                                    {
                                                        <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                                    }
                                                    @if (@i.izvajalec3Id != null)
                                                    {
                                                        <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                                    }
                                                </td>
                                                <td>@i.predmet.letnik</td>
                                                @{ var datum = sh.pridobiDatum(Convert.ToInt32(@p.id)); }
                                                <td>@datum</td>
                                                @{ temp = sh.polaganjaLetos(Convert.ToInt32(@v.id), Convert.ToInt32(@i.id)); }
                                                <td>@temp</td>
                                                @{ temp = sh.polaganjaLetos(Convert.ToInt32(@v.id), Convert.ToInt32(@i.id)); }
                                                <td>@temp</td>
                                                <td>@i.predmet.kreditne</td>
                                                @{ ocena = sh.pridobiOceno(Convert.ToInt32(@p.id)); }
                                                <td>@ocena</td>
                                            </tr>

                                                 if (@ocena != 0)
                                                 {
                                                     if (@ocena > 5)
                                                     {
                                                         tocke += @i.predmet.kreditne;
                                                         stOcen += @ocena;
                                                         sestevek++;
                                                         opravil++;
                                                     }
                                                 }
                                        }
                                    }
                                }
                                if (v.izvajanjes.Contains(i) && pisal == 0)
                                {
                                    <tr>
                                        <td>@i.predmet.koda</td>
                                        <td>@i.predmet.ime</td>
                                        <td>
                                            @i.profesor.ime @i.profesor.priimek
                                            @if (@i.izvajalec2Id != null)
                                            {
                                                <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                            }
                                            @if (@i.izvajalec3Id != null)
                                            {
                                                <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                            }
                                        </td>
                                        <td>@i.predmet.letnik</td>
                                        <td>/</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>@i.predmet.kreditne</td>
                                        <td>/</td>
                                    </tr>
                                }
                            }
                        }
                        else
                        {
                            foreach (var i in @ViewBag.Izvajanja)
                            {
                                var pisal = 0;
                                foreach (var r in @ViewBag.Roki)
                                {
                                    foreach (var p in @ViewBag.Prijave)
                                    {
                                        if (v.izvajanjes.Contains(i) && i.izpitniroks.Contains(r) && p.vpisId == v.id && r.id == p.izpitnirokId && pisal == 0)
                                        {
                                            pisal++;

                                            <tr>
                                                <td>@i.predmet.koda</td>
                                                <td>@i.predmet.ime</td>
                                                <td>
                                                    @i.profesor.ime @i.profesor.priimek
                                                    @if (@i.izvajalec2Id != null)
                                                    {
                                                        <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                                    }
                                                    @if (@i.izvajalec3Id != null)
                                                    {
                                                        <span>, @i.profesor2.ime @i.profesor2.priimek</span>    
                                                    }
                                                </td>
                                                <td>@i.predmet.letnik</td>
                                                @{ var datum = sh.pridobiDatum(Convert.ToInt32(@p.id)); }
                                                <td>@datum</td>
                                                @{ temp = sh.polaganjaVsa(Convert.ToInt32(@v.vpisnaStevilka), Convert.ToInt32(@i.id), Convert.ToInt32(@v.studijskiProgram)); }
                                                <td>@temp</td>
                                                @{ temp = sh.polaganjaLetos(Convert.ToInt32(@v.id), Convert.ToInt32(@i.id)); }
                                                <td>@temp</td>
                                                <td>@i.predmet.kreditne</td>
                                                @{ ocena = sh.pridobiOceno(Convert.ToInt32(@p.id)); }
                                                <td>@ocena</td>
                                            </tr>

                                            if (@ocena != 0)
                                            {
                                                if (@ocena > 5)
                                                {
                                                    tocke += @i.predmet.kreditne;
                                                    stOcen += @ocena;
                                                    sestevek++;
                                                    opravil++;
                                                }
                                            }
                                        }
                                    }         
                                }
                                if (v.izvajanjes.Contains(i) && pisal == 0)
                                {   
                                    <tr>
                                        <td>@i.predmet.koda</td>
                                        <td>@i.predmet.ime</td>
                                        <td>
                                            @i.profesor.ime @i.profesor.priimek
                                            @if (@i.izvajalec2Id != null)
                                            {
                                                <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                            }
                                            @if (@i.izvajalec3Id != null)
                                            {
                                                <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                            }
                                        </td>
                                        <td>@i.predmet.letnik</td>
                                        <td>/</td>
                                        @{ temp = sh.polaganjaVsa(Convert.ToInt32(@v.vpisnaStevilka), Convert.ToInt32(@i.id), Convert.ToInt32(@v.studijskiProgram)); }
                                        <td>@temp</td>
                                        <td>0</td>
                                        <td>@i.predmet.kreditne</td>
                                        <td>/</td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>

                <br />

                <!--- NOGA -->
                <table>
                    <thead>
                        <tr>
                            <th>Študijsko leto</th>
                            <th>Število opravljenih izpitov</th>
                            <th>KT</th>
                            <th>Povprečje</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr>
                            <td>@v.sifrant_studijskoleto.naziv</td>
                            <td>@opravil</td>
                            <td>@tocke</td>
                            <td>
                                @if (stOcen != 0 && sestevek != 0)
                                {
                                    povprecje = stOcen / sestevek;
                                }
                                @povprecje
                            </td>
                        </tr>
                    </tbody>
                </table>
                skupneTocke += tocke;
                skupneOcene += stOcen;
                skupniSestevek += sestevek;

                <br />
                <br />
        }
        </div>
        <!-- Povprečne ocene po študijskih letih  -->
    }

    <!-- Vsa polaganja -->
    if (@ViewBag.Izbira == 1)
    {
        <div id="izpis">
            <!--- foreach {leto študija} -->
            @foreach (var v in @ViewBag.Vpisi)
            {
                var tocke = 0;
                var stOcen = 0.0;
                var sestevek = 0.0;
                var opravil = 0;
                double povprecje = 0;
                int temp;
                int ocena;

                <!-- GLAVA -->
                <h2>@v.sifrant_studijskiprogram.naziv</h2>
                <table>
                    <tbody>
                        <tr>
                            <th>Študijsko leto</th>
                            <td>@v.sifrant_studijskoleto.naziv</td>
                        </tr>
                        <tr>
                            <th>Letnik</th>
                            <td>@v.letnikStudija</td>
                        </tr>
                        @if (@v.letnikStudija == 3 && @v.studijskiProgram == 1000468 && @ViewBag.Moduli != null)
                        {
                            var st = 1;
                            foreach (var mod in @ViewBag.Moduli)
                            {
                                <tr>
                                    <th>Moduli @st</th>
                                    <td>@mod</td>
                                </tr>
                                st++;
                            }
                        }
                        <tr>
                            <th>Vrsta vpisa</th>
                            <td>@v.sifrant_vrstavpisa.naziv</td>
                        </tr>
                        <tr>
                            <th>Način študija</th>
                            <td>@v.sifrant_nacinstudija.naziv</td>
                        </tr>
                    </tbody>
                </table>

                <br />

                <!-- IZPIS -->
                <table>
                    <thead>
                        <tr>
                            <th>Šifra</th>
                            <th>Predmet</th>
                            <th>Izvajalec</th>
                            <th>Letnik</th>
                            <th>Datum</th>
                            <th>Polaganje</th>
                            <th>Polaganje v tem letu</th>
                            <th>KT</th>
                            <th>Ocena</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (v.vrstaVpisa == 2)
                        {
                            foreach (var i in @ViewBag.Izvajanja)
                            {
                                var pisal = 0;
                                var zadnjaOcena = 0;

                                foreach (var r in @ViewBag.Roki)
                                {
                                    foreach (var p in @ViewBag.Prijave)
                                    {
                                        if (@ViewBag.Zacasni.izvajanjes.Contains(i) && i.izpitniroks.Contains(r) && (p.vpisId == @ViewBag.Zacasni.id || p.vpisId == v.id) && r.id == p.izpitnirokId)
                                        {
                                            pisal++;
                                        
                                            <tr>
                                                <td>@i.predmet.koda</td>
                                                <td>@i.predmet.ime</td>
                                                <td>
                                                    @i.profesor.ime @i.profesor.priimek
                                                    @if (@i.izvajalec2Id != null)
                                                    {
                                                        <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                                    }
                                                    @if (@i.izvajalec3Id != null)
                                                    {
                                                        <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                                    }
                                                </td>
                                                <td>@i.predmet.letnik</td>
                                                @{ var datum = sh.pridobiDatum(Convert.ToInt32(@p.id)); }
                                                <td>@datum</td>
                                                @{ temp = sh.zaporednoPolaganjaLetos(Convert.ToInt32(@v.id), Convert.ToInt32(@i.id), Convert.ToInt32(@r.id)); }
                                                <td>@temp</td>
                                                @{ temp = sh.zaporednoPolaganjaLetos(Convert.ToInt32(@v.id), Convert.ToInt32(@i.id), Convert.ToInt32(@r.id)); }
                                                <td>@temp</td>
                                                <td>@i.predmet.kreditne</td>
                                                @{ ocena = sh.pridobiOceno(Convert.ToInt32(@p.id)); }
                                                <td>@ocena</td>
                                            </tr>
                                        
                                            zadnjaOcena = @ocena;
                                        }
                                    }
                                }
                                if (v.izvajanjes.Contains(i) && pisal == 0)
                                {
                                        <tr>
                                            <td>@i.predmet.koda</td>
                                            <td>@i.predmet.ime</td>
                                            <td>
                                                @i.profesor.ime @i.profesor.priimek
                                                @if (@i.izvajalec2Id != null)
                                                {
                                                    <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                                }
                                                @if (@i.izvajalec3Id != null)
                                                {
                                                    <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                                }
                                            </td>
                                            <td>@i.predmet.letnik</td>
                                            <td>/</td>
                                            @{ temp = sh.polaganjaVsa(Convert.ToInt32(@v.vpisnaStevilka), Convert.ToInt32(@i.id), Convert.ToInt32(@v.studijskiProgram)); }
                                            <td>@temp</td>
                                            <td>0</td>
                                            <td>@i.predmet.kreditne</td>
                                            <td>/</td>
                                        </tr>
                                }
                                else
                                {
                                    if (zadnjaOcena > 5)
                                    {
                                        tocke += @i.predmet.kreditne;
                                        stOcen += zadnjaOcena;
                                        sestevek++;
                                        opravil++;
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach (var i in @ViewBag.Izvajanja)
                            {
                                var pisal = 0;
                                var zadnjaOcena = 0;

                                foreach (var r in @ViewBag.Roki)
                                {
                                    foreach (var p in @ViewBag.Prijave)
                                    {
                                        if (v.izvajanjes.Contains(i) && i.izpitniroks.Contains(r) && p.vpisId == v.id && r.id == p.izpitnirokId)
                                        {
                                            pisal++;

                                            <tr>
                                                <td>@i.predmet.koda</td>
                                                <td>@i.predmet.ime</td>
                                                <td>
                                                    @i.profesor.ime @i.profesor.priimek
                                                    @if (@i.izvajalec2Id != null)
                                                    {
                                                        <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                                    }
                                                    @if (@i.izvajalec3Id != null)
                                                    {
                                                        <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                                    }
                                                </td>
                                                <td>@i.predmet.letnik</td>
                                                @{ var datum = sh.pridobiDatum(Convert.ToInt32(@p.id)); }
                                                <td>@datum</td>
                                                @{ temp = sh.zaporednoPolaganje(Convert.ToInt32(@v.vpisnaStevilka), Convert.ToInt32(@i.id), Convert.ToInt32(@v.studijskiProgram), @r.datum); }
                                                <td>@temp</td>
                                                @{ temp = sh.zaporednoPolaganjaLetos(Convert.ToInt32(@v.id), Convert.ToInt32(@i.id), Convert.ToInt32(@r.id)); }
                                                <td>@temp</td>
                                                <td>@i.predmet.kreditne</td>
                                                @{ ocena = sh.pridobiOceno(Convert.ToInt32(@p.id)); }
                                                <td>@ocena</td>
                                            </tr>

                                                 zadnjaOcena = @ocena;
                                        }
                                    }
                                }
                                if (v.izvajanjes.Contains(i) && pisal == 0)
                                {
                                    <tr>
                                        <td>@i.predmet.koda</td>
                                        <td>@i.predmet.ime</td>
                                        <td>
                                            @i.profesor.ime @i.profesor.priimek
                                            @if (@i.izvajalec2Id != null)
                                            {
                                                <span>, @i.profesor1.ime @i.profesor1.priimek</span>
                                            }
                                            @if (@i.izvajalec3Id != null)
                                            {
                                                <span>, @i.profesor2.ime @i.profesor2.priimek</span>
                                            }
                                        </td>
                                        <td>@i.predmet.letnik</td>
                                        <td>/</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>@i.predmet.kreditne</td>
                                        <td>/</td>
                                    </tr>
                                }
                                else
                                {
                                    if (zadnjaOcena > 5)
                                    {
                                        tocke += @i.predmet.kreditne;
                                        stOcen += zadnjaOcena;
                                        sestevek++;
                                        opravil++;
                                    }
                                }
                            }
                        }
                    </tbody>
                </table>

                <br />

                <!--- NOGA -->
                <table>
                    <thead>
                        <tr>
                            <th>Študijsko leto</th>
                            <th>Število opravljenih izpitov</th>
                            <th>KT</th>
                            <th>Povprečje</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr>
                            <td>@v.sifrant_studijskoleto.naziv</td>
                            <td>@opravil</td>
                            <td>@tocke</td>
                            <td>
                                @if (stOcen != 0 && sestevek != 0)
                                {
                                    povprecje = stOcen/sestevek; 
                                }
                                @povprecje
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                skupneTocke += tocke;
                skupneOcene += stOcen;
                skupniSestevek += sestevek;

                <br />
                <br />
            }
        </div>
    }

    <!-- Povprečne ocene po študijskih letih  -->
    <h2>Povprečne ocene po študijskih letih</h2>
    <table>
        <thead>
            <tr>
                <th>Skupaj KT</th>
                <th>Skupno povprečje</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td>@skupneTocke</td>
                <td>
                    @if (skupneOcene != 0 && skupniSestevek != 0)
                    {
                        skupnoPovprecje = skupneOcene / skupniSestevek;
                    }
                    @skupnoPovprecje
                </td>
            </tr>
        </tbody>
    </table>
}